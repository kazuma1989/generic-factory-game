<%- case @game.status %>
<%- when :game_over %>
  <h1 class='display-3 jumbotron'>
    <font color=red>
      💸💀💸 GAME OVER
    </font>
  </h1>
<%- when :completed %>
  <h1 class='display-3 jumbotron'>
    🎉 Game Clear!
  </h1>
<%- end %>

<b><%= @game.player.name %></b>'s game <b><%= @game.id %></b> / month <b><%= @game.month %></b> / <%= @game.status %> / VERSION <%= @game.version %>
<hr>

<div class="row mb-3">
  <div class="col-md-4 themed-grid-col">
    <h2>Schedule</h2>

    <ul>
      <li>
        Done in <b><%= @game.current_month %></b>
        <ul>
          <li>NOT IMPLEMENTED YET
        </ul>
      </li>

      <li>
        Due <b><%= @game.next_month %></b>
        <ul>
          <%- if 0 < @game.salary %>
            <li>Pay <b><%= number_to_currency(@game.salary, precision: 0, format: '%u%nK') %></b> salary.</li>
          <%- end %>
          <%- if 0 < @game.storage %>
            <li>Pay <b><%= number_to_currency(@game.storage / 100, precision: 0, format: '%u%nK') %></b> storage fee.</li>
          <%- end %>
          <%- if @game.debt != 0 %>
            <li>Pay <b><%= number_to_currency(@game.interest, precision: 0, format: '%u%nK') %></b> interest.</li>
          <%- end %>
          <%- if 0 < @game.ingredient_subscription %>
            <li>Pay <b><%= number_to_currency(@game.ingredient_subscription * 0.05, precision: 0, format: '%u%nK') %></b> ingredient subscription.</li>
          <%- end %>
          <%- total_required_products = @game.contracts.map(&:name).map { Contract::RULES[_1][@game.next_month][0] }.sum %>
          <%- if 0 < total_required_products %>
            <li>
              Deliver <b><%= total_required_products %>t</b> products.
              <%- if @game.capped_production + @game.product < total_required_products %>
                ⚠️
              <%- end %>
            </li>
          <%- end %>
        </ul>
      </li>
    </ul>

    <hr>
    <%- if notice %>
      <p id="notice">
      🆕
      <%= notice %>
      </p>
    <%- end %>

    <h2>Actions</h2>

    <%- if @game.status == :in_progress %>
      <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#exampleModal">
        🏦 Bank
      </button>

      <!-- Modal -->
      <div class="modal" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <%= form_with(url: borrow_money_game_url, method: 'post') do |form| %>
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">🏦 Bank</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <ul>
                  <li>You can borrow cash up to $<code>10 * credit</code>K</li>
                  <li>The monthly interest rate is <code>10 - credit/10 %</code></li>
                  <li>Interest rounds up after the decimal point</li>
                  <ul>
                    <li>For example if your credit is 75, the rate is <code>10 - 7.5 = 2.5%</code></li>
                    <li>If you borrow $100K, you must pay $3K every month</li>
                  </ul>
                  <li>When your credit changes, it updates the interest rate immediately</li>
                  <li>You must keep paying the interest until you wipe away the debt</li>
                </ul>

                <%= react_component('Bank', { debt: @game.debt, cash: @game.cash, credit: @game.credit }) %>
              </div>
              <div class="modal-footer">
                <%= form.submit 'Borrow/Pay', class: 'btn btn-primary' %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <br/><br/>

      <!--
        <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#exampleModal" href="<%= new_storages_game_path %>">
      -->
      <button onclick="location.href='<%= new_storages_game_path %>'" type="button" class="btn btn-secondary">
        🗄️ Storage
      </button>

      <br/><br/>

      🏭 <%= link_to 'Build a Factory', new_game_factory_path(@game.id) %> (工場建設)
      <br/><br/>

      💼 <%= link_to 'Hire an employee', new_employee_game_path %> (従業員新規雇用)
      <br/><br/>

      ➡️ <%= link_to 'Dispatch an employee', new_dispatch_game_path %> (従業員の割当)
      <br/><br/>

      <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#buyIngredientModal">
        📦 Buy Ingredient
      </button>

      <!-- Modal -->
      <div class="modal" id="buyIngredientModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <%= form_with(url: buy_ingredients_game_url, method: 'post') do |form| %>
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">📦 Buy Ingredient</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <%= react_component('BuyIngredient', {
                month: @game.month,
                cash: @game.cash,
                storage: @game.storage,
                ingredient: @game.ingredient,
                product: @game.product
              }) %>
            <% end %>
          </div>
        </div>
      </div>
      <br/><br/>

      <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#subscribeIngredientModal">
        📦 Subscribe Ingredient
      </button>

      <!-- Modal -->
      <div class="modal" id="subscribeIngredientModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <%= form_with(url: subscribe_ingredients_game_url, method: 'post') do |form| %>
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">📦 Subscribe Ingredient</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <%= react_component('SubscribeIngredient', {
                cash: @game.cash,
                ingredientSubscription: @game.ingredient_subscription.to_i,
              }) %>
            <% end %>
          </div>
        </div>
      </div>
      <br/><br/>

      📜 <%= link_to 'Make a contract', new_game_contract_path(@game.id) %> (新規契約を結ぶ)
      <br/><br/>

      <%= form_with(url: end_month_game_url, method: 'post') do |form| %>
        <small>
          Estimated new cash: <b>$<%= @estimate.cash %>K</b>
        </small>
        <br/>
        <%- if @estimate.status == :game_over %>
          <div class="alert alert-danger" role="alert">
            Your cash will run out! Try borrowing some cash to survive.
          </div>
        <%- end %>
        <%= form.submit 'End month', class: "btn btn-lg #{ {in_progress: 'btn-primary', game_over: 'btn-danger', completed: 'btn-success'}[@estimate.status]}" %>
        <small class="form-text text-muted">
          You employees work to produce product, and you deliver the accumulated product to your customers until they're satisfied.
        </small>
      <% end %>
    <%- end %>
  </div>
  <div class="col-md-8 themed-grid-col">
    <h2>Current status</h2>

    <table>
      <tr>
        <th><strong>Date</strong></th>
        <td>
          <%= @game.current_month %> <%= 2020 + @game.month / 12 %>
        </td>
        <td></td>
      </tr>


      <tr>
        <th><strong>Money</strong></th>
        <td>
          <% if @game.debt == 0 %>
            <b><%= number_to_currency(@game.cash, precision: 0, format: '%u%nK') %></b>
          <% else %>
            Cash:
            <b><%= number_to_currency(@game.cash, precision: 0, format: '%u%nK') %></b>
            <br>
            Debt:
            <b><%= number_to_currency(@game.debt, precision: 0, format: '%u%nK') %></b>
            <br>
            Total:
            <b><%= number_to_currency(@game.cash - @game.debt, precision: 0, format: '%u%nK') %></b>
          <% end %>
        </td>
        <td></td>
      </tr>

      <tr>
        <th><strong>Credit</strong></th>
        <td><%= @game.credit %></td>
        <td></td>
      </tr>

      <tr>
        <th><strong>Storage</strong></th>
        <td>
          Size: <%= @game.storage %>t
          <br>
          Ingredient: <%= @game.ingredient %>t (+ <%= @game.ingredient_subscription %>t)
          <br>
          Product: <%= @game.product %>t
        </td>
        <td>
          <%= link_to '🗄️', new_storages_game_path if @game.status == :in_progress %>
          <br>
          📦
          <br>
          <br>
        </td>
      </tr>

      <tr>
        <th><strong>Idle Employees</strong></th>
        <td>
          <%- @game.idle_factory.junior.times do %>
            <img src='/images/employee-junior.png' width=16 title=junior>
          <%- end %>
          <%- @game.idle_factory.intermediate.times do %>
            <img src='/images/employee-intermediate.png' width=16 title=intermediate>
          <%- end %>
          <%- @game.idle_factory.senior.times do %>
            <img src='/images/employee-senior.png' width=16 title=senior>
          <%- end %>
        </td>
        <td>
          <%= link_to '💼', new_employee_game_path if @game.status == :in_progress %>
        </td>
      </tr>

      <tr>
        <th><strong>Factories</strong></th>
        <td>
          <%= @game.active_factories.map(&:name).join(', ') %>
        </td>
        <td>
          <%= link_to '🏭', new_game_factory_path(@game.id) if @game.status == :in_progress %>
        </td>
      </tr>

      <tr>
        <th><strong>Contracts</strong></th>
        <td>
          <%= @game.contracts.map(&:name).join(', ') %>
        </td>
        <td>
          <%= link_to '📜', new_game_contract_path(@game.id) if @game.status == :in_progress %>
        </td>
      </tr>

    </table>

    <p>
    <h3>Factory</h3>
    <table>
      <tr>
        <th>Name</th>
        <th>Juniors assigned</th>
        <th>Intermediates assigned</th>
        <th>Seniors assigned</th>
      </tr>
      <%- @game.active_factories.each do |factory| %>
        <tr>
          <td><%= factory.name.capitalize %></td>
          <td>
            <%- factory.junior.times do %>
              <img src='/images/employee-junior.png' width=16 title=junior>
            <%- end %>
          </td>
          <td>
            <%- factory.intermediate.times do %>
              <img src='/images/employee-intermediate.png' width=16 title=intermediate>
            <%- end %>
          </td>
          <td>
            <%- factory.senior.times do %>
              <img src='/images/employee-senior.png' width=16 title=senior>
            <%- end %>
          </td>
        </tr>
      <%- end %>
    </table>
    <div style='text-align: right'>
      <%= link_to '➡️', new_dispatch_game_path if @game.status == :in_progress %>
    </div>

    <ul>
      <li>
        Estimated Ingredients Consumption: <%= @game.production * 2 %>t
        <%- if @game.production != @game.capped_production %>
          <ul>
            <li><font color=red>(Capped to <%= @game.capped_production * 2 %>t, because you don't have much ingredients!)</font>
          </ul>
        <%- end %>
      </li>
      <li>
        Estimated Product Generation: <%= @game.production %>t
        <%- if @game.production != @game.capped_production %>
          <ul>
            <li><font color=red>(Capped to <%= @game.capped_production %>t, because you don't have much ingredients!)</font>
          </ul>
        <%- end %>
      </li>
    </ul>
    </p>
    <p>
      <strong>Contracts:</strong>
      <ul>
        <%- @game.contracts.each do |contract| %>
          <li>Contract <%= contract.name %> (<%= Contract::DESCRIPTIONS[contract.name] %>)</li>
        <%- end %>
      </ul>
    </p>

    <br/>
  </div>
</div>
